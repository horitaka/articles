---
title: "Pythonã®unittestã§mockã‚’ä½¿ç”¨ã™ã‚‹"
emoji: "ğŸ™Œ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [Python, test]
published: true
---

# æ¦‚è¦

- Pythonã®unittestã§é–¢æ•°ã‚’ãƒ¢ãƒƒã‚¯åŒ–ã™ã‚‹æ–¹æ³•ã§ã™
- ãƒ¢ãƒƒã‚¯åŒ–ã™ã‚‹ã«ã¯unittest.mockã®MagicMockã‚‚ã—ãã¯patchã‚’ä½¿ç”¨ã—ã¾ã™
- APIã®å‘¼ã³å‡ºã—ãªã©ã§requestsã‚’ä½¿ç”¨ã—ã¦ãŠã‚Šã€requestsã‚’ãƒ¢ãƒƒã‚¯ã«ã™ã‚‹å ´åˆã¯requests-mockã¨ã„ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã§ãã¾ã™

**ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±**
- Python: 3.10.7
- requests-mock: 1.10.0

**å„ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®å…¬å¼ã‚µã‚¤ãƒˆ**
- [unittest.mock](https://docs.python.org/ja/3/library/unittest.mock-examples.html)
- [requests-mock](https://requests-mock.readthedocs.io/en/latest/index.html)


**ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰**
ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã¯[ã“ã¡ã‚‰](https://github.com/horitaka/python-mock-sample)ã§ã™ã€‚


# å¯¾è±¡ã®ã‚³ãƒ¼ãƒ‰
ä»Šå›ã®è¨˜äº‹ã§ã¯å¤–éƒ¨APIã®å‘¼ã³å‡ºã—(api.call_api)ã‚’ãƒ¢ãƒƒã‚¯ã«ã™ã‚‹ã“ã¨ã‚’æƒ³å®šã—ã¾ã™ã€‚

```py:sample.py
import api

def main(url):
    response = api.call_api(url)
    return response.text
```
```py:api.py
import requests

# ã“ã®é–¢æ•°ã‚’ãƒ¢ãƒƒã‚¯åŒ–ã™ã‚‹
def call_api(url):
    response = requests.get(url)
    return response
```

# MagicMockã‚’ä½¿ç”¨ã™ã‚‹

## é–¢æ•°ã‚’mockã«ã™ã‚‹
é–¢æ•°ã‚’mockã«ã™ã‚‹ã«ã¯MagicMockã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
assert_called_withã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§mockã«ã—ãŸé–¢æ•°ãŒå‘¼ã°ã‚ŒãŸã‹ã©ã†ã‹ã‚’æ¤œè¨¼ã§ãã¾ã™ã€‚

```py:test_sample.py
class TestSample(unittest.TestCase):
    def test_mock_called(self):
        # api.call_apiã‚’mockã«ã™ã‚‹
        mock = MagicMock()
        api.call_api = mock
        
        url = "https://example.com"
        main(url)

        # call_apiãŒã€"https://example.com"ã®å¼•æ•°ã§å‘¼ã°ã‚ŒãŸã“ã¨ã‚’æ¤œè¨¼ã™ã‚‹
        mock.assert_called_with("https://example.com")
```

## æˆ»ã‚Šå€¤ã‚’è¨­å®šã™ã‚‹
mockã®æˆ»ã‚Šå€¤ã‚’è¨­å®šã™ã‚‹å ´åˆã¯ã€MagicMockã®return_valueã‚’è¨­å®šã—ã¾ã™ã€‚

```py:test_sample.py
class ResponseMock:
    def __init__(self, text):
        self.text = text

class TestSample(unittest.TestCase):
    def test_mock_return_value(self):
        # call_apiã‚’ãƒ¢ãƒƒã‚¯åŒ–ã—ã¦ã€æˆ»ã‚Šå€¤ã‚’ResponseMock("mocked_text")ã«è¨­å®šã™ã‚‹
        mock = MagicMock(return_value=ResponseMock("mocked_text"))
        api.call_api = mock

        url = "https://example.com"
        result = main(url)

        self.assertEqual(result, "mocked_text")
```

## æˆ»ã‚Šå€¤ã‚’å¤‰ãˆã‚‹
é–¢æ•°ã®å‘¼ã³å‡ºã—æ–¹æ³•ã«ã‚ˆã£ã¦mockã®æˆ»ã‚Šå€¤ã‚’å¤‰ãˆãŸã„å ´åˆã¯ã€MagicMockã®side_effectã‚’è¨­å®šã—ã¾ã™ã€‚
argsã«ã¯é–¢æ•°ã‚’å‘¼ã³å‡ºã—ãŸã¨ãã®å¼•æ•°ãŒå…¥ã£ã¦ã„ã‚‹ãŸã‚ã€ä»¥ä¸‹ã®ä¾‹ã§ã¯argsã®å€¤ã«ã‚ˆã£ã¦æˆ»ã‚Šå€¤ã‚’å¤‰ãˆã¦ã„ã¾ã™ã€‚

```py:test_sample.py
class TestSample(unittest.TestCase):
    def test_mock_side_effect(self):
        # argsã«ã¯call_apiã‚’å‘¼ã³å‡ºã—ãŸã¨ãã®å¼•æ•°ãŒå…¥ã‚‹
        # å¼•æ•°ã«ã‚ˆã£ã¦æˆ»ã‚Šå€¤ã‚’å¤‰ãˆã‚‹
        def mock_return_value(*args, **kwargs):
            if args[0] == "https://example.com":
                result = "mocked_text"
            else:
                result = "not_found_text"
            return ResponseMock(result)
        mock = MagicMock(side_effect=mock_return_value)
        api.call_api = mock

        # test1
        url = "https://example.com"
        result = main(url)

        self.assertEqual(result, "mocked_text")

        # test2
        url = "https://notfound.com"
        result = main(url)

        self.assertEqual(result, "not_found_text")
```


# patchã‚’ä½¿ã†
ç‰¹å®šã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ã„ã‚‹ã¨ãã ã‘mockã«ã—ãŸã„ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
ãã†ã„ã£ãŸå ´åˆã¯patchã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

## context managerã¨ã—ã¦ä½¿ç”¨ã™ã‚‹
patchã‚’context managerã¨ã—ã¦ä½¿ç”¨ã™ã‚‹æ–¹æ³•ã§ã™ã€‚

```py:test_sample.py
class TestSamplePatch(unittest.TestCase):
    def test_mock_patch(self):
        mock = MagicMock(return_value=ResponseMock("mocked_text"))
        with patch('api.call_api', mock):
            print(api.call_api)
            # output: <MagicMock id='xxxxxxxxxx'>
            url = "https://example.com"
            result = main(url)

            self.assertEqual(result, "mocked_text")

        print(api.call_api)
        # output: <function call_api at xxxxxxxxx>
```

## decoratorã‚’ä½¿ç”¨ã™ã‚‹
ã¾ãŸã€patchã¯decoratorã¨ã—ã¦ã‚‚ä½¿ç”¨ã§ãã¾ã™ã€‚

```py:test_sample.py
class TestSamplePatch(unittest.TestCase):

    mock = MagicMock(return_value=ResponseMock("mocked_text"))
    @patch('api.call_api', mock)
    def test_mock_patch_decorator(self):
        url = "https://example.com"
        result = main(url)

        self.assertEqual(result, "mocked_text")
```


# requests-mockã‚’ä½¿ç”¨ã™ã‚‹
å¤–éƒ¨APIã®å‘¼ã³å‡ºã—ã«requestsã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã¯requests-mockã‚’ä½¿ç”¨ã™ã‚Œã°ç°¡å˜ã«requestsã‚’mockåŒ–ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```py:test_sample.py
class TestSampleRequestMock(unittest.TestCase):
    def test_mock_request(self):
        url = "https://example.com"
        with requests_mock.Mocker() as mock:
            mock.get(url, text="mocked_text")

            result = main(url)
            
            self.assertEqual(result, "mocked_text")
```
